<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Absensi Premium - Ponpes Darul 'Izzi Wadda'wah</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #1a2a3a, #2c3e50);
            color: white;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            border: 1px solid rgba(255,255,255,0.2);
        }

        .arabic-text {
            font-size: 1.8rem;
            color: #ffd700;
            margin-bottom: 10px;
            font-family: 'Traditional Arabic', serif;
        }

        .header h1 {
            font-size: 2rem;
            margin-bottom: 10px;
            color: #ffd700;
        }

        .login-section, .dashboard {
            background: rgba(255,255,255,0.1);
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 20px;
            border: 1px solid rgba(255,255,255,0.2);
        }

        .role-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .role-btn {
            flex: 1;
            padding: 15px;
            border: none;
            border-radius: 10px;
            background: rgba(255,255,255,0.2);
            color: white;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s;
        }

        .role-btn.active {
            background: #3498db;
            transform: translateY(-2px);
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
        }

        .input-group input, .input-group select, .input-group textarea {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 8px;
            background: rgba(255,255,255,0.9);
            font-size: 16px;
        }

        .btn {
            padding: 15px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-primary {
            background: #3498db;
            color: white;
        }

        .btn-success {
            background: #2ecc71;
            color: white;
        }

        .btn-danger {
            background: #e74c3c;
            color: white;
        }

        .btn-warning {
            background: #f39c12;
            color: white;
        }

        .hidden {
            display: none !important;
        }

        .card {
            background: rgba(255,255,255,0.1);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border: 1px solid rgba(255,255,255,0.2);
        }

        .card-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(255,255,255,0.2);
        }

        .card-header i {
            color: #ffd700;
            font-size: 1.5rem;
        }

        .camera-container {
            width: 100%;
            height: 250px;
            background: rgba(0,0,0,0.3);
            border-radius: 10px;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 15px;
            overflow: hidden;
            position: relative;
        }

        .camera-container video, .camera-container canvas, .photo-preview {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .camera-controls {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-bottom: 15px;
        }

        .attendance-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            font-size: 0.9rem;
        }

        .attendance-table th, .attendance-table td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid rgba(255,255,255,0.2);
        }

        .attendance-table th {
            background: rgba(0,0,0,0.3);
            font-weight: bold;
        }

        .status-badge {
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
        }

        .status-hadir { background: #2ecc71; }
        .status-sakit { background: #f39c12; }
        .status-ijin { background: #3498db; }

        .user-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .user-card {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: #3498db;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
        }

        .user-info h4 {
            margin-bottom: 5px;
        }

        .user-info p {
            font-size: 0.9rem;
            opacity: 0.8;
        }

        .user-actions {
            margin-left: auto;
            display: flex;
            gap: 5px;
        }

        .action-btn {
            padding: 5px 10px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.8rem;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #ffd700;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            text-align: center;
        }

        .alert-success { background: rgba(46, 204, 113, 0.2); }
        .alert-error { background: rgba(231, 76, 60, 0.2); }

        .quick-action {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        .quick-card {
            background: rgba(255,255,255,0.1);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            border: 1px solid rgba(255,255,255,0.2);
            cursor: pointer;
            transition: all 0.3s;
        }

        .quick-card:hover {
            transform: translateY(-3px);
            background: rgba(255,255,255,0.15);
        }

        .quick-card i {
            font-size: 2.5rem;
            color: #ffd700;
            margin-bottom: 10px;
        }

        .quick-card h4 {
            margin-bottom: 5px;
            color: #ffd700;
        }

        .welcome-arabic {
            text-align: center;
            font-size: 1.5rem;
            color: #ffd700;
            margin-bottom: 20px;
            font-family: 'Traditional Arabic', serif;
            padding: 15px;
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            border: 1px solid rgba(255,255,255,0.2);
        }

        .instant-save {
            background: #2ecc71 !important;
            animation: pulse 0.5s ease-in-out;
        }

        .photo-preview {
            border-radius: 10px;
            border: 2px solid #ffd700;
        }

        .gps-info {
            background: rgba(52, 152, 219, 0.2);
            padding: 10px;
            border-radius: 8px;
            margin-top: 10px;
            font-size: 0.9rem;
        }

        .map-link {
            color: #ffd700;
            text-decoration: none;
            font-weight: bold;
        }

        .map-link:hover {
            text-decoration: underline;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        @media (max-width: 768px) {
            .role-buttons {
                flex-direction: column;
            }
            
            .user-list {
                grid-template-columns: 1fr;
            }
            
            .quick-action {
                grid-template-columns: 1fr;
            }
            
            .attendance-table {
                font-size: 0.8rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="arabic-text">اهلا وسهلا بمعهد دار العز و الدعوة</div>
            <h1>Ponpes Darul 'Izzi Wadda'wah Semarang</h1>
            <p>Sistem Absensi Premium</p>
        </div>

        <!-- Login Section -->
        <div id="loginSection" class="login-section">
            <h2 style="text-align: center; margin-bottom: 20px; color: #ffd700;">Login Sistem</h2>
            
            <div class="role-buttons">
                <button class="role-btn active" data-role="owner">Owner</button>
                <button class="role-btn" data-role="guru">Guru</button>
                <button class="role-btn" data-role="murid">Murid</button>
            </div>

            <div class="input-group">
                <label for="username">Username</label>
                <input type="text" id="username" placeholder="Masukkan username">
            </div>

            <div class="input-group">
                <label for="password">Password / PIN</label>
                <input type="password" id="password" placeholder="Masukkan password atau PIN">
            </div>

            <button class="btn btn-primary" id="loginBtn" style="width: 100%;">
                <i class="fas fa-sign-in-alt"></i> Login
            </button>

            <div id="loginMessage" class="alert hidden"></div>
        </div>

        <!-- Owner Dashboard -->
        <div id="ownerDashboard" class="dashboard hidden">
            <div class="welcome-arabic">اهلا وسهلا بمعهد دار العز و الدعوة - لوحة تحكم المالك</div>
            
            <!-- Quick Actions -->
            <div class="quick-action">
                <div class="quick-card" onclick="showAddUserForm()">
                    <i class="fas fa-user-plus"></i>
                    <h4>Tambah User Baru</h4>
                    <p>Klik untuk tambah guru/murid</p>
                </div>
                <div class="quick-card" onclick="refreshData()">
                    <i class="fas fa-sync-alt"></i>
                    <h4>Refresh Data</h4>
                    <p>Perbarui data terbaru</p>
                </div>
            </div>

            <!-- Add User Form -->
            <div id="addUserForm" class="card">
                <div class="card-header">
                    <i class="fas fa-users"></i>
                    <h3>Tambah Pengguna Baru</h3>
                </div>
                <div class="input-group">
                    <label for="newUsername">Username</label>
                    <input type="text" id="newUsername" placeholder="Username baru">
                </div>
                <div class="input-group">
                    <label for="newPassword">PIN</label>
                    <input type="password" id="newPassword" placeholder="PIN 4 digit">
                </div>
                <div class="input-group">
                    <label for="newNama">Nama Lengkap</label>
                    <input type="text" id="newNama" placeholder="Nama lengkap">
                </div>
                <div class="input-group">
                    <label for="newRole">Role</label>
                    <select id="newRole">
                        <option value="guru">Guru</option>
                        <option value="murid">Murid</option>
                    </select>
                </div>
                <button class="btn btn-success" id="addUserBtn" onclick="addUserQuick()">
                    <i class="fas fa-user-plus"></i> Tambah Pengguna
                </button>
            </div>

            <div class="card">
                <div class="card-header">
                    <i class="fas fa-list"></i>
                    <h3>Daftar Pengguna</h3>
                    <span id="userCount" class="loading" style="margin-left: auto;">Memuat...</span>
                </div>
                <div id="userList" class="user-list">
                    <div class="loading">Memuat data pengguna...</div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <i class="fas fa-chart-bar"></i>
                    <h3>Data Absensi Semua User</h3>
                    <span id="attendanceCount" class="loading" style="margin-left: auto;">Memuat...</span>
                </div>
                <div style="overflow-x: auto;">
                    <table class="attendance-table">
                        <thead>
                            <tr>
                                <th>Foto</th>
                                <th>Nama</th>
                                <th>Role</th>
                                <th>Tanggal</th>
                                <th>Status</th>
                                <th>Jam</th>
                                <th>Pelajaran</th>
                                <th>Alasan</th>
                                <th>GPS</th>
                            </tr>
                        </thead>
                        <tbody id="allAttendanceTable">
                            <tr><td colspan="9" class="loading">Memuat data absensi...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <button class="btn btn-danger" id="ownerLogout" style="width: 100%; margin-top: 20px;">
                <i class="fas fa-sign-out-alt"></i> Logout
            </button>
        </div>

        <!-- Guru Dashboard -->
        <div id="guruDashboard" class="dashboard hidden">
            <div class="welcome-arabic">اهلا وسهلا بمعهد دار العز و الدعوة - لوحة تحكم المعلم</div>
            
            <div class="card">
                <div class="card-header">
                    <i class="fas fa-camera"></i>
                    <h3>Absensi Guru</h3>
                </div>
                <div class="input-group">
                    <label for="guruStatus">Status Kehadiran</label>
                    <select id="guruStatus">
                        <option value="hadir">Hadir</option>
                        <option value="sakit">Sakit</option>
                        <option value="ijin">Ijin</option>
                    </select>
                </div>
                <div class="input-group" id="guruAlasanGroup">
                    <label for="guruAlasan">Alasan/Keterangan</label>
                    <textarea id="guruAlasan" placeholder="Masukkan alasan sakit/ijin atau keterangan hadir"></textarea>
                </div>
                <div class="camera-container">
                    <video id="guruCamera" autoplay></video>
                    <canvas id="guruCanvas" class="hidden"></canvas>
                    <img id="guruPhotoPreview" class="photo-preview hidden">
                </div>
                <div class="camera-controls">
                    <button class="btn btn-warning" id="guruCaptureBtn">
                        <i class="fas fa-camera"></i> Ambil Foto
                    </button>
                    <button class="btn btn-warning" id="guruRetakeBtn">
                        <i class="fas fa-redo"></i> Ulangi Foto
                    </button>
                </div>
                <div id="guruGPSInfo" class="gps-info hidden">
                    <i class="fas fa-map-marker-alt"></i> 
                    <span id="guruLocationText">Mendeteksi lokasi...</span>
                </div>
                <button class="btn btn-success" id="guruSubmitBtn">
                    <i class="fas fa-check"></i> Submit Absensi
                </button>
            </div>

            <div class="card">
                <div class="card-header">
                    <i class="fas fa-list"></i>
                    <h3>Absensi Murid Hari Ini</h3>
                </div>
                <div style="overflow-x: auto;">
                    <table class="attendance-table">
                        <thead>
                            <tr>
                                <th>Foto</th>
                                <th>Nama Murid</th>
                                <th>Pelajaran</th>
                                <th>Status</th>
                                <th>Jam</th>
                                <th>GPS</th>
                            </tr>
                        </thead>
                        <tbody id="muridAttendanceTable">
                            <tr><td colspan="6" class="loading">Memuat data murid...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <button class="btn btn-danger" id="guruLogout" style="width: 100%; margin-top: 20px;">
                <i class="fas fa-sign-out-alt"></i> Logout
            </button>
        </div>

        <!-- Murid Dashboard -->
        <div id="muridDashboard" class="dashboard hidden">
            <div class="welcome-arabic">اهلا وسهلا بمعهد دار العز و الدعوة - لوحة تحكم الطالب</div>
            
            <div class="card">
                <div class="card-header">
                    <i class="fas fa-camera"></i>
                    <h3>Absensi Murid</h3>
                </div>
                <div class="input-group">
                    <label for="muridPelajaran">Pelajaran</label>
                    <input type="text" id="muridPelajaran" placeholder="Tulis nama pelajaran (contoh: Matematika, Bahasa Arab, dll)">
                </div>
                <div class="input-group">
                    <label for="muridStatus">Status Kehadiran</label>
                    <select id="muridStatus">
                        <option value="hadir">Hadir</option>
                        <option value="sakit">Sakit</option>
                        <option value="ijin">Ijin</option>
                    </select>
                </div>
                <div class="input-group" id="muridAlasanGroup">
                    <label for="muridAlasan">Alasan/Keterangan</label>
                    <textarea id="muridAlasan" placeholder="Masukkan alasan sakit/ijin atau keterangan hadir"></textarea>
                </div>
                <div class="camera-container">
                    <video id="muridCamera" autoplay></video>
                    <canvas id="muridCanvas" class="hidden"></canvas>
                    <img id="muridPhotoPreview" class="photo-preview hidden">
                </div>
                <div class="camera-controls">
                    <button class="btn btn-warning" id="muridCaptureBtn">
                        <i class="fas fa-camera"></i> Ambil Foto
                    </button>
                    <button class="btn btn-warning" id="muridRetakeBtn">
                        <i class="fas fa-redo"></i> Ulangi Foto
                    </button>
                </div>
                <div id="muridGPSInfo" class="gps-info hidden">
                    <i class="fas fa-map-marker-alt"></i> 
                    <span id="muridLocationText">Mendeteksi lokasi...</span>
                </div>
                <button class="btn btn-success" id="muridSubmitBtn">
                    <i class="fas fa-check"></i> Submit Absensi
                </button>
            </div>

            <div class="card">
                <div class="card-header">
                    <i class="fas fa-history"></i>
                    <h3>Riwayat Absensi Saya</h3>
                </div>
                <div style="overflow-x: auto;">
                    <table class="attendance-table">
                        <thead>
                            <tr>
                                <th>Foto</th>
                                <th>Tanggal</th>
                                <th>Pelajaran</th>
                                <th>Status</th>
                                <th>Jam</th>
                                <th>Alasan</th>
                                <th>GPS</th>
                            </tr>
                        </thead>
                        <tbody id="riwayatTable">
                            <tr><td colspan="7" class="loading">Memuat riwayat...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <button class="btn btn-danger" id="muridLogout" style="width: 100%; margin-top: 20px;">
                <i class="fas fa-sign-out-alt"></i> Logout
            </button>
        </div>
    </div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDT5t1Cp46SXngmNlAptTcSmtuOAoGBRVo",
            authDomain: "absensi-sekolah-46657.firebaseapp.com",
            projectId: "absensi-sekolah-46657",
            storageBucket: "absensi-sekolah-46657.firebasestorage.app",
            messagingSenderId: "1061158300214",
            appId: "1:1061158300214:web:cfb0fe13791e1e09988697"
        };

        // Initialize Firebase
        try {
            firebase.initializeApp(firebaseConfig);
            console.log("Firebase initialized successfully");
        } catch (error) {
            console.error("Firebase initialization error:", error);
        }
        
        const db = firebase.firestore();
        const storage = firebase.storage();

        // Global Variables
        let currentUser = null;
        let selectedRole = 'owner';
        let cachedUsers = JSON.parse(localStorage.getItem('cachedUsers') || '[]');
        let cachedAttendance = JSON.parse(localStorage.getItem('cachedAttendance') || '[]');
        let currentLocation = null;

        // Save cache to localStorage
        function saveCache() {
            localStorage.setItem('cachedUsers', JSON.stringify(cachedUsers));
            localStorage.setItem('cachedAttendance', JSON.stringify(cachedAttendance));
        }

        // Initialize App
        document.addEventListener('DOMContentLoaded', function() {
            console.log("App initialized");
            initializeApp();
            setupEventListeners();
            initializeOwnerAccount();
            getCurrentLocation();
        });

        // GPS Function
        function getCurrentLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const lat = position.coords.latitude;
                        const lng = position.coords.longitude;
                        currentLocation = { lat, lng };
                        
                        // Get address from coordinates (simplified)
                        const locationText = `Lat: ${lat.toFixed(6)}, Lng: ${lng.toFixed(6)}`;
                        const mapUrl = `https://maps.google.com/?q=${lat},${lng}`;
                        
                        document.getElementById('guruLocationText').innerHTML = 
                            `<a href="${mapUrl}" target="_blank" class="map-link">${locationText}</a>`;
                        document.getElementById('muridLocationText').innerHTML = 
                            `<a href="${mapUrl}" target="_blank" class="map-link">${locationText}</a>`;
                            
                        document.getElementById('guruGPSInfo').classList.remove('hidden');
                        document.getElementById('muridGPSInfo').classList.remove('hidden');
                    },
                    (error) => {
                        console.error("GPS Error:", error);
                        currentLocation = { lat: -6.9667, lng: 110.4167 }; // Default Semarang
                        const locationText = "Semarang (Lokasi default)";
                        document.getElementById('guruLocationText').textContent = locationText;
                        document.getElementById('muridLocationText').textContent = locationText;
                        document.getElementById('guruGPSInfo').classList.remove('hidden');
                        document.getElementById('muridGPSInfo').classList.remove('hidden');
                    }
                );
            } else {
                currentLocation = { lat: -6.9667, lng: 110.4167 };
                const locationText = "Semarang (GPS tidak support)";
                document.getElementById('guruLocationText').textContent = locationText;
                document.getElementById('muridLocationText').textContent = locationText;
                document.getElementById('guruGPSInfo').classList.remove('hidden');
                document.getElementById('muridGPSInfo').classList.remove('hidden');
            }
        }

        // SUPER FAST Owner Account Setup
        async function initializeOwnerAccount() {
            try {
                const ownerExists = cachedUsers.some(user => user.username === 'owner');
                
                if (!ownerExists) {
                    const ownerRef = await db.collection('users').add({
                        username: 'owner',
                        password: '1234',
                        nama: 'Owner Ponpes',
                        role: 'owner',
                        createdAt: new Date()
                    });
                    
                    cachedUsers.push({
                        id: ownerRef.id,
                        username: 'owner',
                        password: '1234',
                        nama: 'Owner Ponpes',
                        role: 'owner'
                    });
                    saveCache();
                    console.log("Owner account created!");
                }
            } catch (error) {
                console.error("Error initializing owner account:", error);
            }
        }

        function initializeApp() {
            const savedUser = localStorage.getItem('currentUser');
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                showDashboard(currentUser.role);
            }
        }

        function setupEventListeners() {
            // Role buttons
            document.querySelectorAll('.role-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.role-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    selectedRole = this.getAttribute('data-role');
                });
            });

            // Login button
            document.getElementById('loginBtn').addEventListener('click', login);
            document.getElementById('password').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') login();
            });

            // Logout buttons
            document.getElementById('ownerLogout').addEventListener('click', logout);
            document.getElementById('guruLogout').addEventListener('click', logout);
            document.getElementById('muridLogout').addEventListener('click', logout);

            // Guru buttons
            document.getElementById('guruCaptureBtn').addEventListener('click', () => capturePhoto('guru'));
            document.getElementById('guruRetakeBtn').addEventListener('click', () => retakePhoto('guru'));
            document.getElementById('guruSubmitBtn').addEventListener('click', submitGuruAbsensi);

            // Murid buttons
            document.getElementById('muridCaptureBtn').addEventListener('click', () => capturePhoto('murid'));
            document.getElementById('muridRetakeBtn').addEventListener('click', () => retakePhoto('murid'));
            document.getElementById('muridSubmitBtn').addEventListener('click', submitMuridAbsensi);
        }

        // SUPER FAST Login Function
        async function login() {
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value.trim();

            if (!username || !password) {
                showMessage('Username dan password harus diisi!', 'error');
                return;
            }

            const loginBtn = document.getElementById('loginBtn');
            loginBtn.disabled = true;
            loginBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading...';

            try {
                let userFound = cachedUsers.find(user => 
                    user.username === username && user.password === password
                );

                if (!userFound) {
                    const usersSnapshot = await db.collection('users').get();
                    cachedUsers = [];
                    
                    usersSnapshot.forEach(doc => {
                        const userData = doc.data();
                        cachedUsers.push({ id: doc.id, ...userData });
                        
                        if (userData.username === username && userData.password === password) {
                            userFound = { id: doc.id, ...userData };
                        }
                    });
                    saveCache();
                }

                if (!userFound) {
                    showMessage('Username atau password salah!', 'error');
                    return;
                }

                if (userFound.role !== selectedRole) {
                    showMessage(`Anda login sebagai ${userFound.role}, bukan ${selectedRole}`, 'error');
                    return;
                }

                currentUser = userFound;
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                showDashboard(userFound.role);
                showMessage('Login berhasil!', 'success');

                document.getElementById('username').value = '';
                document.getElementById('password').value = '';

            } catch (error) {
                console.error("Login error:", error);
                showMessage('Error: ' + error.message, 'error');
            } finally {
                loginBtn.disabled = false;
                loginBtn.innerHTML = '<i class="fas fa-sign-in-alt"></i> Login';
            }
        }

        function showDashboard(role) {
            hideAllSections();
            
            switch(role) {
                case 'owner':
                    ownerDashboard.classList.remove('hidden');
                    loadOwnerData();
                    break;
                case 'guru':
                    guruDashboard.classList.remove('hidden');
                    startCamera('guru');
                    loadGuruData();
                    break;
                case 'murid':
                    muridDashboard.classList.remove('hidden');
                    startCamera('murid');
                    loadMuridData();
                    break;
            }
        }

        function hideAllSections() {
            loginSection.classList.add('hidden');
            ownerDashboard.classList.add('hidden');
            guruDashboard.classList.add('hidden');
            muridDashboard.classList.add('hidden');
        }

        // Quick Action Functions
        function showAddUserForm() {}
        function refreshData() {
            if (currentUser && currentUser.role === 'owner') {
                loadOwnerData(true);
            } else if (currentUser && currentUser.role === 'guru') {
                loadGuruData(true);
            } else if (currentUser && currentUser.role === 'murid') {
                loadMuridData(true);
            }
        }

        // INSTANT Add User Function
        async function addUserQuick() {
            const username = document.getElementById('newUsername').value.trim();
            const password = document.getElementById('newPassword').value.trim();
            const nama = document.getElementById('newNama').value.trim();
            const role = document.getElementById('newRole').value;

            if (!username || !password || !nama) {
                alert('Semua field harus diisi!');
                return;
            }

            const addBtn = document.getElementById('addUserBtn');
            const originalText = addBtn.innerHTML;
            
            addBtn.classList.add('instant-save');
            addBtn.disabled = true;
            addBtn.innerHTML = '<i class="fas fa-check"></i> Berhasil!';

            try {
                const usernameExists = cachedUsers.some(user => user.username === username);
                if (usernameExists) {
                    alert('Username sudah digunakan!');
                    return;
                }

                const tempUser = { 
                    id: 'temp_' + Date.now(), 
                    username, 
                    password, 
                    nama, 
                    role 
                };
                cachedUsers.push(tempUser);
                saveCache();
                displayUsers(cachedUsers);

                document.getElementById('newUsername').value = '';
                document.getElementById('newPassword').value = '';
                document.getElementById('newNama').value = '';

                setTimeout(async () => {
                    try {
                        const newUserRef = await db.collection('users').add({
                            username: username,
                            password: password,
                            nama: nama,
                            role: role,
                            createdAt: new Date()
                        });

                        const userIndex = cachedUsers.findIndex(user => user.id === tempUser.id);
                        if (userIndex !== -1) {
                            cachedUsers[userIndex].id = newUserRef.id;
                            saveCache();
                        }
                    } catch (error) {
                        console.error("Background save error:", error);
                    }
                }, 100);

            } catch (error) {
                console.error("Add user error:", error);
                alert('Error: ' + error.message);
            } finally {
                setTimeout(() => {
                    addBtn.disabled = false;
                    addBtn.innerHTML = originalText;
                    addBtn.classList.remove('instant-save');
                }, 1500);
            }
        }

        // Photo Functions
        function capturePhoto(role) {
            const camera = document.getElementById(role + 'Camera');
            const canvas = document.getElementById(role + 'Canvas');
            const preview = document.getElementById(role + 'PhotoPreview');
            
            const context = canvas.getContext('2d');
            canvas.width = camera.videoWidth;
            canvas.height = camera.videoHeight;
            context.drawImage(camera, 0, 0, canvas.width, canvas.height);
            
            // Convert to data URL for preview
            const photoDataUrl = canvas.toDataURL('image/jpeg');
            preview.src = photoDataUrl;
            
            camera.classList.add('hidden');
            canvas.classList.add('hidden');
            preview.classList.remove('hidden');
        }

        function retakePhoto(role) {
            const camera = document.getElementById(role + 'Camera');
            const canvas = document.getElementById(role + 'Canvas');
            const preview = document.getElementById(role + 'PhotoPreview');
            
            preview.classList.add('hidden');
            canvas.classList.add('hidden');
            camera.classList.remove('hidden');
        }

        async function uploadPhoto(photoDataUrl, fileName) {
            try {
                const response = await fetch(photoDataUrl);
                const blob = await response.blob();
                
                const storageRef = storage.ref().child('absensi_photos/' + fileName);
                const snapshot = await storageRef.put(blob);
                const downloadURL = await snapshot.ref.getDownloadURL();
                
                return downloadURL;
            } catch (error) {
                console.error("Upload photo error:", error);
                return null;
            }
        }

        // Owner Functions
        async function loadOwnerData(forceRefresh = false) {
            try {
                if (forceRefresh || cachedUsers.length === 0) {
                    const usersSnapshot = await db.collection('users').get();
                    cachedUsers = [];
                    usersSnapshot.forEach(doc => {
                        cachedUsers.push({ id: doc.id, ...doc.data() });
                    });
                    saveCache();
                }

                if (forceRefresh || cachedAttendance.length === 0) {
                    const attendanceSnapshot = await db.collection('absensi')
                        .orderBy('timestamp', 'desc')
                        .limit(100)
                        .get();
                    cachedAttendance = [];
                    attendanceSnapshot.forEach(doc => {
                        cachedAttendance.push({ id: doc.id, ...doc.data() });
                    });
                    saveCache();
                }

                displayUsers(cachedUsers);
                displayAllAttendance(cachedAttendance);

            } catch (error) {
                console.error("Load owner data error:", error);
            }
        }

        function displayUsers(users) {
            const userList = document.getElementById('userList');
            const userCount = document.getElementById('userCount');
            
            const nonOwnerUsers = users.filter(user => user.role !== 'owner');
            userCount.textContent = `${nonOwnerUsers.length} Pengguna`;
            
            userList.innerHTML = '';

            if (nonOwnerUsers.length === 0) {
                userList.innerHTML = '<div class="loading">Tidak ada pengguna</div>';
                return;
            }

            nonOwnerUsers.forEach(user => {
                const userCard = document.createElement('div');
                userCard.className = 'user-card';
                userCard.innerHTML = `
                    <div class="user-avatar">
                        <i class="fas fa-user"></i>
                    </div>
                    <div class="user-info">
                        <h4>${user.nama}</h4>
                        <p>${user.role} | ${user.username} | PIN: ${user.password}</p>
                    </div>
                    <div class="user-actions">
                        <button class="action-btn btn-danger" onclick="deleteUser('${user.id}')">
                            <i class="fas fa-trash"></i> Hapus
                        </button>
                    </div>
                `;
                userList.appendChild(userCard);
            });
        }

        function displayAllAttendance(attendance) {
            const tableBody = document.getElementById('allAttendanceTable');
            const attendanceCount = document.getElementById('attendanceCount');
            
            attendanceCount.textContent = `${attendance.length} Absensi`;
            tableBody.innerHTML = '';

            if (attendance.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="9" class="loading">Tidak ada data absensi</td></tr>';
                return;
            }

            const recentAttendance = attendance.slice(0, 50);
            
            recentAttendance.forEach(absen => {
                const row = document.createElement('tr');
                const statusClass = `status-${absen.status}`;
                const alasan = absen.alasan || '-';
                const pelajaran = absen.pelajaran || '-';
                const fotoUrl = absen.foto_url || '';
                const gpsUrl = absen.gps_url || '#';
                const gpsText = absen.gps_text || 'Tidak ada GPS';

                row.innerHTML = `
                    <td>
                        ${fotoUrl ? 
                            `<img src="${fotoUrl}" style="width: 50px; height: 50px; object-fit: cover; border-radius: 5px; border: 1px solid #ffd700;">` : 
                            '<i class="fas fa-camera" style="color: #ccc;"></i>'
                        }
                    </td>
                    <td>${absen.nama}</td>
                    <td>${absen.role}</td>
                    <td>${absen.tanggal}</td>
                    <td><span class="status-badge ${statusClass}">${absen.status}</span></td>
                    <td>${absen.jam_masuk}</td>
                    <td>${pelajaran}</td>
                    <td>${alasan}</td>
                    <td>
                        <a href="${gpsUrl}" target="_blank" class="map-link" style="font-size: 0.8rem;">
                            <i class="fas fa-map-marker-alt"></i> Lihat
                        </a>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }

        // Guru Functions
        async function loadGuruData(forceRefresh = false) {
            try {
                const today = new Date().toISOString().split('T')[0];
                
                if (forceRefresh) {
                    const attendanceSnapshot = await db.collection('absensi')
                        .where('role', '==', 'murid')
                        .where('tanggal', '==', today)
                        .get();
                    
                    const todayAttendance = [];
                    attendanceSnapshot.forEach(doc => {
                        todayAttendance.push({ id: doc.id, ...doc.data() });
                    });
                    displayMuridAttendance(todayAttendance);
                } else {
                    const cachedTodayAttendance = cachedAttendance.filter(absen => 
                        absen.role === 'murid' && absen.tanggal === today
                    );
                    displayMuridAttendance(cachedTodayAttendance);
                    
                    setTimeout(async () => {
                        const attendanceSnapshot = await db.collection('absensi')
                            .where('role', '==', 'murid')
                            .where('tanggal', '==', today)
                            .get();
                        
                        const todayAttendance = [];
                        attendanceSnapshot.forEach(doc => {
                            todayAttendance.push({ id: doc.id, ...doc.data() });
                        });
                        displayMuridAttendance(todayAttendance);
                    }, 1000);
                }
            } catch (error) {
                console.error("Load guru data error:", error);
            }
        }

        function displayMuridAttendance(attendance) {
            const tableBody = document.getElementById('muridAttendanceTable');
            tableBody.innerHTML = '';

            if (attendance.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="6" class="loading">Tidak ada absensi hari ini</td></tr>';
                return;
            }

            attendance.forEach(absen => {
                const row = document.createElement('tr');
                const statusClass = `status-${absen.status}`;
                const pelajaran = absen.pelajaran || '-';
                const fotoUrl = absen.foto_url || '';
                const gpsUrl = absen.gps_url || '#';

                row.innerHTML = `
                    <td>
                        ${fotoUrl ? 
                            `<img src="${fotoUrl}" style="width: 40px; height: 40px; object-fit: cover; border-radius: 5px;">` : 
                            '<i class="fas fa-camera" style="color: #ccc;"></i>'
                        }
                    </td>
                    <td>${absen.nama}</td>
                    <td>${pelajaran}</td>
                    <td><span class="status-badge ${statusClass}">${absen.status}</span></td>
                    <td>${absen.jam_masuk}</td>
                    <td>
                        <a href="${gpsUrl}" target="_blank" class="map-link" style="font-size: 0.8rem;">
                            <i class="fas fa-map-marker-alt"></i> Map
                        </a>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }

        // Murid Functions
        async function loadMuridData(forceRefresh = false) {
            try {
                if (forceRefresh) {
                    const attendanceSnapshot = await db.collection('absensi')
                        .where('userId', '==', currentUser.id)
                        .orderBy('timestamp', 'desc')
                        .limit(20)
                        .get();
                    
                    const userAttendance = [];
                    attendanceSnapshot.forEach(doc => {
                        userAttendance.push({ id: doc.id, ...doc.data() });
                    });
                    displayRiwayat(userAttendance);
                } else {
                    const cachedUserAttendance = cachedAttendance
                        .filter(absen => absen.userId === currentUser.id)
                        .slice(0, 20);
                    displayRiwayat(cachedUserAttendance);
                    
                    setTimeout(async () => {
                        const attendanceSnapshot = await db.collection('absensi')
                            .where('userId', '==', currentUser.id)
                            .orderBy('timestamp', 'desc')
                            .limit(20)
                            .get();
                        
                        const userAttendance = [];
                        attendanceSnapshot.forEach(doc => {
                            userAttendance.push({ id: doc.id, ...doc.data() });
                        });
                        displayRiwayat(userAttendance);
                    }, 1000);
                }
            } catch (error) {
                console.error("Load murid data error:", error);
            }
        }

        function displayRiwayat(attendance) {
            const tableBody = document.getElementById('riwayatTable');
            tableBody.innerHTML = '';

            if (attendance.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="7" class="loading">Belum ada riwayat absensi</td></tr>';
                return;
            }

            attendance.forEach(absen => {
                const row = document.createElement('tr');
                const statusClass = `status-${absen.status}`;
                const alasan = absen.alasan || '-';
                const pelajaran = absen.pelajaran || '-';
                const fotoUrl = absen.foto_url || '';
                const gpsUrl = absen.gps_url || '#';

                row.innerHTML = `
                    <td>
                        ${fotoUrl ? 
                            `<img src="${fotoUrl}" style="width: 40px; height: 40px; object-fit: cover; border-radius: 5px;">` : 
                            '<i class="fas fa-camera" style="color: #ccc;"></i>'
                        }
                    </td>
                    <td>${absen.tanggal}</td>
                    <td>${pelajaran}</td>
                    <td><span class="status-badge ${statusClass}">${absen.status}</span></td>
                    <td>${absen.jam_masuk}</td>
                    <td>${alasan}</td>
                    <td>
                        <a href="${gpsUrl}" target="_blank" class="map-link" style="font-size: 0.8rem;">
                            <i class="fas fa-map-marker-alt"></i> Map
                        </a>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }

        // Camera Functions
        function startCamera(role) {
            const constraints = { video: { width: 640, height: 480, facingMode: "user" } };
            const camera = document.getElementById(role + 'Camera');
            
            navigator.mediaDevices.getUserMedia(constraints)
                .then(stream => {
                    camera.srcObject = stream;
                })
                .catch(error => {
                    console.error('Camera error:', error);
                    alert('Tidak dapat mengakses kamera. Pastikan izin kamera sudah diberikan.');
                });
        }

        function stopCamera(role) {
            const camera = document.getElementById(role + 'Camera');
            if (camera.srcObject) {
                camera.srcObject.getTracks().forEach(track => track.stop());
            }
        }

        // INSTANT Submit Functions dengan FOTO dan GPS
        async function submitGuruAbsensi() {
            const status = document.getElementById('guruStatus').value;
            const alasan = document.getElementById('guruAlasan').value.trim();

            if (!alasan) {
                alert('Harap isi alasan/keterangan!');
                return;
            }

            const preview = document.getElementById('guruPhotoPreview');
            if (preview.classList.contains('hidden')) {
                alert('Harap ambil foto terlebih dahulu!');
                return;
            }

            const now = new Date();
            const tanggal = now.toISOString().split('T')[0];
            const jam = now.toTimeString().split(' ')[0].substring(0, 5);

            const submitBtn = document.getElementById('guruSubmitBtn');
            
            submitBtn.classList.add('instant-save');
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Menyimpan...';

            try {
                // Upload photo
                const canvas = document.getElementById('guruCanvas');
                const photoDataUrl = canvas.toDataURL('image/jpeg');
                const fileName = `guru_${currentUser.id}_${Date.now()}.jpg`;
                const fotoUrl = await uploadPhoto(photoDataUrl, fileName);

                // GPS data
                const gpsUrl = `https://maps.google.com/?q=${currentLocation.lat},${currentLocation.lng}`;
                const gpsText = `Lat: ${currentLocation.lat.toFixed(6)}, Lng: ${currentLocation.lng.toFixed(6)}`;

                const newAbsensi = {
                    userId: currentUser.id,
                    nama: currentUser.nama,
                    role: 'guru',
                    tanggal: tanggal,
                    jam_masuk: jam,
                    jam_pulang: status === 'hadir' ? '16:00' : '-',
                    status: status,
                    alasan: alasan,
                    pelajaran: '-', // Guru tidak ada pelajaran
                    foto_url: fotoUrl,
                    gps_url: gpsUrl,
                    gps_text: gpsText,
                    lokasi: `Lat: ${currentLocation.lat}, Lng: ${currentLocation.lng}`,
                    timestamp: new Date()
                };

                // Save to Firebase
                await db.collection('absensi').add(newAbsensi);

                // Update cache
                cachedAttendance.unshift(newAbsensi);
                if (cachedAttendance.length > 100) cachedAttendance.pop();
                saveCache();

                alert('Absensi berhasil disimpan!');
                
                // Reset form
                document.getElementById('guruStatus').value = 'hadir';
                document.getElementById('guruAlasan').value = '';
                retakePhoto('guru');

            } catch (error) {
                alert('Error: ' + error.message);
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="fas fa-check"></i> Submit Absensi';
                submitBtn.classList.remove('instant-save');
            }
        }

        async function submitMuridAbsensi() {
            const status = document.getElementById('muridStatus').value;
            const alasan = document.getElementById('muridAlasan').value.trim();
            const pelajaran = document.getElementById('muridPelajaran').value.trim();

            if (!pelajaran) {
                alert('Harap isi nama pelajaran!');
                return;
            }

            if (!alasan) {
                alert('Harap isi alasan/keterangan!');
                return;
            }

            const preview = document.getElementById('muridPhotoPreview');
            if (preview.classList.contains('hidden')) {
                alert('Harap ambil foto terlebih dahulu!');
                return;
            }

            const now = new Date();
            const tanggal = now.toISOString().split('T')[0];
            const jam = now.toTimeString().split(' ')[0].substring(0, 5);

            const submitBtn = document.getElementById('muridSubmitBtn');
            
            submitBtn.classList.add('instant-save');
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Menyimpan...';

            try {
                // Upload photo
                const canvas = document.getElementById('muridCanvas');
                const photoDataUrl = canvas.toDataURL('image/jpeg');
                const fileName = `murid_${currentUser.id}_${Date.now()}.jpg`;
                const fotoUrl = await uploadPhoto(photoDataUrl, fileName);

                // GPS data
                const gpsUrl = `https://maps.google.com/?q=${currentLocation.lat},${currentLocation.lng}`;
                const gpsText = `Lat: ${currentLocation.lat.toFixed(6)}, Lng: ${currentLocation.lng.toFixed(6)}`;

                const newAbsensi = {
                    userId: currentUser.id,
                    nama: currentUser.nama,
                    role: 'murid',
                    tanggal: tanggal,
                    jam_masuk: jam,
                    jam_pulang: status === 'hadir' ? '16:00' : '-',
                    status: status,
                    alasan: alasan,
                    pelajaran: pelajaran,
                    foto_url: fotoUrl,
                    gps_url: gpsUrl,
                    gps_text: gpsText,
                    lokasi: `Lat: ${currentLocation.lat}, Lng: ${currentLocation.lng}`,
                    timestamp: new Date()
                };

                // Save to Firebase
                await db.collection('absensi').add(newAbsensi);

                // Update cache
                cachedAttendance.unshift(newAbsensi);
                if (cachedAttendance.length > 100) cachedAttendance.pop();
                saveCache();

                alert('Absensi berhasil disimpan!');
                
                // Reset form
                document.getElementById('muridStatus').value = 'hadir';
                document.getElementById('muridAlasan').value = '';
                document.getElementById('muridPelajaran').value = '';
                retakePhoto('murid');
                
                // Reload data
                loadMuridData(true);

            } catch (error) {
                alert('Error: ' + error.message);
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="fas fa-check"></i> Submit Absensi';
                submitBtn.classList.remove('instant-save');
            }
        }

        // Common Functions
        function logout() {
            currentUser = null;
            localStorage.removeItem('currentUser');
            stopCamera('guru');
            stopCamera('murid');
            hideAllSections();
            loginSection.classList.remove('hidden');
            showMessage('Logout berhasil!', 'success');
        }

        function showMessage(message, type) {
            const loginMessage = document.getElementById('loginMessage');
            loginMessage.textContent = message;
            loginMessage.className = `alert alert-${type}`;
            loginMessage.classList.remove('hidden');
            
            setTimeout(() => {
                loginMessage.classList.add('hidden');
            }, 3000);
        }

        async function deleteUser(userId) {
            if (confirm('Apakah Anda yakin ingin menghapus user ini?')) {
                try {
                    cachedUsers = cachedUsers.filter(user => user.id !== userId);
                    saveCache();
                    displayUsers(cachedUsers);
                    
                    setTimeout(async () => {
                        try {
                            await db.collection('users').doc(userId).delete();
                        } catch (error) {
                            console.error("Background delete error:", error);
                        }
                    }, 100);
                    
                    alert('User berhasil dihapus!');
                } catch (error) {
                    alert('Error menghapus user: ' + error.message);
                }
            }
        }

        // Make functions available globally
        window.deleteUser = deleteUser;
        window.showAddUserForm = showAddUserForm;
        window.refreshData = refreshData;
        window.addUserQuick = addUserQuick;

        console.log("App setup completed successfully");
    </script>
</body>
</html>